name: Verify Ubuntu1-1 Setup

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ubuntu1-1/**'
      - '.github/workflows/verify-ubuntu1-1.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ubuntu1-1/**'
      - '.github/workflows/verify-ubuntu1-1.yml'
  workflow_dispatch:

defaults:
  run:
    working-directory: ubuntu1-1

jobs:
  syntax-check:
    name: Check Script Syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check syntax
        run: make test-syntax

  shellcheck:
    name: Shellcheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          export PATH=/usr/bin:$PATH
          make shellcheck

  nix-check:
    name: Validate Nix Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Run Nix flake check
        run: |
          # cachix/install-nix-action sets up PATH automatically
          # Just verify nix is available
          which nix || echo "Nix not found in PATH"
          nix --version || echo "Nix command failed"
          make nix-check

  docker-integration-test:
    name: Docker Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display system info
        run: |
          echo "════════════════════════════════════════════"
          echo "  System Information"
          echo "════════════════════════════════════════════"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f 2)"
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo "CPU Cores: $(nproc)"
          echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
          echo "Disk Space: $(df -h / | tail -1 | awk '{print $4}') available"
          echo "════════════════════════════════════════════"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker test image
        run: |
          echo "Building Docker test image..."
          docker build -t ubuntu-nix-test -f Dockerfile.test .

      - name: Run tests in Docker container
        run: |
          echo "Running tests in Docker container..."
          echo "This may take 10-15 minutes (downloading and building packages)..."
          echo ""
          docker run --rm \
            -e TERM=xterm-256color \
            ubuntu-nix-test

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "════════════════════════════════════════════"
          echo "  ✅ ALL DOCKER TESTS PASSED"
          echo "════════════════════════════════════════════"
          echo ""
          echo "Verified in Docker container:"
          echo "  ✓ Nix installation"
          echo "  ✓ Home Manager installation"
          echo "  ✓ All 16 tools installed correctly"
          echo "  ✓ Git configuration working"
          echo "  ✓ Git delta integration working"
          echo "  ✓ Nix environment working"
          echo ""
          echo "Configuration is ready for deployment!"
