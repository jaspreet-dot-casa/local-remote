#!/bin/bash
#==============================================================================
# local-remote-login - Post-login authentication setup
#
# Run this after first login to set up:
#   1. Import SSH authorized keys from GitHub
#   2. Tailscale authentication
#   3. Git SSH key generation and GitHub authentication
#
# Usage: local-remote-login
#
# Individual steps can also be run separately:
#   ./scripts/local-remote/import-github-keys.sh [username]
#   ./scripts/local-remote/setup-tailscale.sh
#   ./scripts/local-remote/setup-git-ssh.sh
#==============================================================================

set -e
set -u
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOCAL_REMOTE_DIR="${SCRIPT_DIR}/local-remote"

# Source common functions
source "${LOCAL_REMOTE_DIR}/common.sh"

# Source individual setup scripts
source "${LOCAL_REMOTE_DIR}/import-github-keys.sh"
source "${LOCAL_REMOTE_DIR}/setup-tailscale.sh"
source "${LOCAL_REMOTE_DIR}/setup-git-ssh.sh"

#==============================================================================
# Summary
#==============================================================================

print_summary() {
    log_section "Setup Complete"

    echo ""
    echo "Authentication setup is complete. Summary:"
    echo ""

    # Authorized keys status
    local auth_keys_file="$HOME/.ssh/authorized_keys"
    if [[ -f "$auth_keys_file" ]]; then
        local key_count
        key_count=$(wc -l < "$auth_keys_file" | tr -d ' ')
        echo "  Authorized Keys: $key_count key(s) in ~/.ssh/authorized_keys"
    else
        echo "  Authorized Keys: not configured"
    fi

    # Tailscale status
    if command -v tailscale &>/dev/null; then
        local ts_status
        ts_status=$(tailscale status 2>&1 | head -1 || echo "unknown")
        echo "  Tailscale: $ts_status"
    else
        echo "  Tailscale: not installed"
    fi

    # Git SSH key status
    if [[ -f "$HOME/.ssh/id_ed25519" ]]; then
        echo "  SSH Key: configured"
    else
        echo "  SSH Key: not configured"
    fi

    # GitHub status
    if command -v gh &>/dev/null && gh auth status &>/dev/null; then
        local gh_user
        gh_user=$(gh api user -q .login 2>/dev/null || echo "unknown")
        echo "  GitHub: authenticated as $gh_user"
    else
        echo "  GitHub: not authenticated"
    fi

    echo ""
    echo "You're all set! Try:"
    echo "  git clone git@github.com:your-username/your-repo.git"
    echo ""
}

#==============================================================================
# Main
#==============================================================================

main() {
    echo ""
    echo -e "${BOLD}local-remote-login${NC} - Post-login authentication setup"
    echo ""

    import_github_keys
    setup_tailscale
    setup_git_ssh
    print_summary
}

main "$@"
