#!/bin/bash
#==============================================================================
# local-remote-login - Post-login authentication setup
#
# Run this after first login to set up:
#   1. Import SSH authorized keys from GitHub
#   2. Tailscale authentication
#   3. Git SSH key generation and GitHub authentication
#
# Usage: local-remote-login
#==============================================================================

set -e
set -u
set -o pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

log_info()    { echo -e "${BLUE}→ $1${NC}"; }
log_success() { echo -e "${GREEN}✓ $1${NC}"; }
log_warning() { echo -e "${YELLOW}⚠ $1${NC}"; }
log_error()   { echo -e "${RED}✗ $1${NC}" >&2; }

log_section() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════════${NC}"
    echo -e "${BLUE}${BOLD}$1${NC}"
    echo -e "${BLUE}════════════════════════════════════════════${NC}"
}

#==============================================================================
# Import SSH Authorized Keys from GitHub
#==============================================================================

import_github_keys() {
    log_section "Import SSH Keys from GitHub"

    local ssh_dir="$HOME/.ssh"
    local auth_keys_file="$ssh_dir/authorized_keys"

    # Try to get GitHub username from various sources
    local github_username=""

    # 1. Try gh CLI if authenticated
    if command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1; then
        github_username=$(gh api user -q .login 2>/dev/null || echo "")
    fi

    # 2. If not found, ask the user
    if [[ -z "$github_username" ]]; then
        echo -n "Enter your GitHub username: "
        read -r github_username
    fi

    if [[ -z "$github_username" ]]; then
        log_warning "No GitHub username provided. Skipping key import."
        return 0
    fi

    log_info "Fetching SSH keys for GitHub user: $github_username"

    # Fetch keys from GitHub
    local github_keys_url="https://github.com/${github_username}.keys"
    local keys
    keys=$(curl -fsSL "$github_keys_url" 2>/dev/null || echo "")

    if [[ -z "$keys" ]]; then
        log_warning "No SSH keys found for $github_username (or user not found)"
        return 0
    fi

    # Count keys
    local key_count
    key_count=$(echo "$keys" | wc -l | tr -d ' ')
    log_info "Found $key_count SSH key(s)"

    # Ensure .ssh directory exists
    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir"

    # Create authorized_keys if it doesn't exist
    touch "$auth_keys_file"
    chmod 600 "$auth_keys_file"

    # Add keys that aren't already present
    local added=0
    while IFS= read -r key; do
        [[ -z "$key" ]] && continue

        # Check if key already exists
        if grep -qF "$key" "$auth_keys_file" 2>/dev/null; then
            log_info "Key already exists (skipping): ${key:0:40}..."
        else
            echo "$key" >> "$auth_keys_file"
            ((added++))
            log_success "Added key: ${key:0:40}..."
        fi
    done <<< "$keys"

    if [[ $added -gt 0 ]]; then
        log_success "Added $added new SSH key(s) to authorized_keys"
    else
        log_info "All keys already present in authorized_keys"
    fi

    echo ""
    echo "You can now SSH to this machine using your GitHub SSH keys."
}

#==============================================================================
# Tailscale Authentication
#==============================================================================

setup_tailscale() {
    log_section "Tailscale Authentication"

    if ! command -v tailscale &>/dev/null; then
        log_warning "Tailscale is not installed. Skipping."
        return 0
    fi

    # Check if already authenticated
    local status
    status=$(tailscale status 2>&1 || true)

    if [[ "$status" != *"Logged out"* ]] && [[ "$status" != *"not logged in"* ]] && [[ "$status" != *"NeedsLogin"* ]]; then
        log_success "Tailscale already authenticated"
        echo ""
        echo "Current status:"
        tailscale status 2>/dev/null | head -5 || true
        return 0
    fi

    log_info "Starting Tailscale authentication..."
    echo ""
    echo "This will open a browser or display a URL to authenticate."
    echo ""

    # Start tailscale with SSH enabled
    sudo tailscale up --ssh --advertise-exit-node

    log_success "Tailscale authenticated"
    echo ""
    tailscale status 2>/dev/null | head -5 || true
}

#==============================================================================
# Git SSH Key Setup
#==============================================================================

setup_git_ssh() {
    log_section "Git SSH Key Setup"

    local ssh_dir="$HOME/.ssh"
    local key_file="$ssh_dir/id_ed25519"
    local pub_key_file="${key_file}.pub"

    # Check if key already exists
    if [[ -f "$key_file" ]]; then
        log_success "SSH key already exists: $key_file"
        echo ""
        echo "Public key:"
        cat "$pub_key_file"
        echo ""
    else
        log_info "Generating new SSH key..."

        # Get email for key
        local email
        email=$(git config --global user.email 2>/dev/null || echo "")

        if [[ -z "$email" ]]; then
            echo -n "Enter your email for the SSH key: "
            read -r email
        fi

        mkdir -p "$ssh_dir"
        chmod 700 "$ssh_dir"

        ssh-keygen -t ed25519 -C "$email" -f "$key_file" -N ""

        log_success "SSH key generated"
        echo ""
        echo "Public key:"
        cat "$pub_key_file"
        echo ""
    fi

    # Ensure SSH agent is running and key is added
    eval "$(ssh-agent -s)" &>/dev/null || true
    ssh-add "$key_file" 2>/dev/null || true

    # Check if gh is installed for GitHub auth
    if command -v gh &>/dev/null; then
        setup_github_ssh "$pub_key_file"
    else
        log_warning "GitHub CLI (gh) not installed. Skipping GitHub SSH setup."
        echo ""
        echo "To add this key to GitHub manually:"
        echo "  1. Go to https://github.com/settings/keys"
        echo "  2. Click 'New SSH key'"
        echo "  3. Paste the public key shown above"
    fi
}

setup_github_ssh() {
    local pub_key_file="$1"

    log_section "GitHub Authentication"

    # Check if already authenticated with gh
    if gh auth status &>/dev/null; then
        log_success "Already authenticated with GitHub CLI"

        # Check if SSH key is already added
        local key_content
        key_content=$(cat "$pub_key_file")
        local key_fingerprint
        key_fingerprint=$(ssh-keygen -lf "$pub_key_file" | awk '{print $2}')

        if gh ssh-key list 2>/dev/null | grep -q "$key_fingerprint"; then
            log_success "SSH key already added to GitHub"
            return 0
        fi
    else
        log_info "Authenticating with GitHub..."
        echo ""
        echo "This will open a browser to authenticate with GitHub."
        echo ""

        gh auth login --web --git-protocol ssh

        log_success "GitHub authenticated"
    fi

    # Add SSH key to GitHub
    log_info "Adding SSH key to GitHub..."

    local hostname
    hostname=$(hostname)
    local key_title="local-remote@${hostname}"

    if gh ssh-key add "$pub_key_file" --title "$key_title" 2>/dev/null; then
        log_success "SSH key added to GitHub as '$key_title'"
    else
        log_warning "Could not add SSH key (may already exist)"
    fi

    # Test SSH connection
    log_info "Testing GitHub SSH connection..."
    if ssh -T git@github.com 2>&1 | grep -q "successfully authenticated"; then
        log_success "GitHub SSH connection working"
    else
        log_warning "GitHub SSH test returned unexpected result (this may be OK)"
    fi
}

#==============================================================================
# Summary
#==============================================================================

print_summary() {
    log_section "Setup Complete"

    echo ""
    echo "Authentication setup is complete. Summary:"
    echo ""

    # Authorized keys status
    local auth_keys_file="$HOME/.ssh/authorized_keys"
    if [[ -f "$auth_keys_file" ]]; then
        local key_count
        key_count=$(wc -l < "$auth_keys_file" | tr -d ' ')
        echo "  Authorized Keys: $key_count key(s) in ~/.ssh/authorized_keys"
    else
        echo "  Authorized Keys: not configured"
    fi

    # Tailscale status
    if command -v tailscale &>/dev/null; then
        local ts_status
        ts_status=$(tailscale status 2>&1 | head -1 || echo "unknown")
        echo "  Tailscale: $ts_status"
    else
        echo "  Tailscale: not installed"
    fi

    # Git SSH key status
    if [[ -f "$HOME/.ssh/id_ed25519" ]]; then
        echo "  SSH Key: configured"
    else
        echo "  SSH Key: not configured"
    fi

    # GitHub status
    if command -v gh &>/dev/null && gh auth status &>/dev/null; then
        local gh_user
        gh_user=$(gh api user -q .login 2>/dev/null || echo "unknown")
        echo "  GitHub: authenticated as $gh_user"
    else
        echo "  GitHub: not authenticated"
    fi

    echo ""
    echo "You're all set! Try:"
    echo "  git clone git@github.com:your-username/your-repo.git"
    echo ""
}

#==============================================================================
# Main
#==============================================================================

main() {
    echo ""
    echo -e "${BOLD}local-remote-login${NC} - Post-login authentication setup"
    echo ""

    import_github_keys
    setup_tailscale
    setup_git_ssh
    print_summary
}

main "$@"
