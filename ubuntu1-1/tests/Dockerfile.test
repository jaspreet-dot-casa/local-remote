# Dockerfile for Cloud-Init Integration Tests
#
# This container simulates an Ubuntu server environment for testing
# the cloud-init scripts without actually provisioning a VM.
#
# Usage:
#   docker build -t cloud-init-test -f tests/Dockerfile.test .
#   docker run --rm cloud-init-test bash tests/test-runner.sh

FROM ubuntu:22.04

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install base packages (similar to cloud-init packages)
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    zsh \
    tree \
    jq \
    htop \
    unzip \
    build-essential \
    ca-certificates \
    gnupg \
    apt-transport-https \
    gettext-base \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create test user
RUN useradd -m -s /bin/bash testuser \
    && echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set working directory
WORKDIR /workspace

# Copy project files
COPY . .

# Make scripts executable
RUN chmod +x scripts/**/*.sh cloud-init/*.sh tests/*.sh 2>/dev/null || true

# Set environment for testing
ENV DRY_RUN=true
ENV HOME=/home/testuser
ENV USER=testuser

# Default command
CMD ["bash", "tests/test-runner.sh"]
